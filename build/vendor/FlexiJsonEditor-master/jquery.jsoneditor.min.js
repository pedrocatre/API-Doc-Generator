// Copyright (c) 2013 David Durman

// Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php).

(function(e){function t(t,n,r,i,s,o){t={target:t,onchange:r,onpropertyclick:i,original:n,propertyElement:s,valueElement:o},f(t,n,t.target),e(t.target).on("blur focus",".property, .value",function(){e(this).toggleClass("editing")})}function n(e){return"[object Object]"==Object.prototype.toString.call(e)}function r(e){return"[object Array]"==Object.prototype.toString.call(e)}function i(e,t,n){var r=2==arguments.length;if(-1<t.indexOf(".")){for(var i=e,s=0,o=t.split("."),u=o.length;s<u-1;s++)i=i[o[s]];r?delete i[o[u-1]]:i[o[u-1]]=n}else r?delete e[t]:e[t]=n;return e}function s(e){var t;try{t=JSON.parse(e)}catch(n){t=null,window.console&&console.error("JSON parse failed.")}return t}function o(e){var t;try{t=JSON.stringify(e)}catch(n){t="null",window.console&&console.error("JSON stringify failed.")}return t}function u(t){if(0==t.children(".expander").length){var n=e("<span>",{"class":"expander"});n.bind("click",function(){e(this).parent().toggleClass("expanded")}),t.prepend(n)}}function a(t,n){var r=e("<div>",{"class":"item appender"}),i=e("<button></button>",{"class":"property"});return i.text("Add New Value"),r.append(i),t.append(r),i.click(n),r}function f(t,i,l,v){v=v||"",l.children(".item").remove();for(var g in i)if(i.hasOwnProperty(g)){var b=e("<div>",{"class":"item","data-path":v}),E=e(t.propertyElement||"<input>",{"class":"property"}),S=e(t.valueElement||"<input>",{"class":"value"});(n(i[g])||r(i[g]))&&u(b),b.append(E).append(S),l.append(b),E.val(g).attr("title",g);var T=o(i[g]);S.val(T).attr("title",T),d(b,i[g]),E.change(h(t)),S.change(p(t)),E.click(c(t)),(n(i[g])||r(i[g]))&&f(t,i[g],b,(v?v+".":"")+g)}(n(i)||r(i))&&a(l,function(){if(r(i))i.push(null);else if(n(i)){for(var e=1,u="newKey";i.hasOwnProperty(u);)u="newKey"+e,e++;i[u]=null}f(t,i,l,v),t.onchange(s(o(t.original)))})}function l(t,n){e(t).parentsUntil(n.target).each(function(){var t=e(this).data("path"),t=(t?t+".":t)+e(this).children(".property").val(),r;e:{r=n.original;for(var t=t.split("."),i=0;i<t.length;)if(void 0==(r=r[t[i++]])){r=null;break e}}r=o(r),e(this).children(".value").val(r).attr("title",r)})}function c(t){return function(){var n=e(this).parent().data("path"),r=e(this).attr("title"),n=n?n.split(".").concat([r]).join("']['"):r;t.onpropertyclick("['"+n+"']")}}function h(t){return function(){var n=e(this).parent().data("path"),r=s(e(this).next().val()),u=e(this).val(),a=e(this).attr("title");e(this).attr("title",u),i(t.original,(n?n+".":"")+a),u&&i(t.original,(n?n+".":"")+u,r),l(this,t),u||e(this).parent().remove(),t.onchange(s(o(t.original)))}}function p(t){return function(){var a=e(this).prev().val(),c=s(e(this).val()||"null"),h=e(this).parent(),p=h.data("path");i(t.original,(p?p+".":"")+a,c),!n(c)&&!r(c)||e.isEmptyObject(c)?h.find(".expander, .item").remove():(f(t,c,h,(p?p+".":"")+a),u(h)),d(h,c),l(this,t),t.onchange(s(o(t.original)))}}function d(e,t){var i="null";n(t)?i="object":r(t)?i="array":"[object Boolean]"==Object.prototype.toString.call(t)?i="boolean":"[object String]"==Object.prototype.toString.call(t)?i="string":"[object Number]"==Object.prototype.toString.call(t)&&(i="number"),e.removeClass(v),e.addClass(i)}e.fn.jsonEditor=function(n,r){r=r||{},n=s(o(n));var i=function(){},u=r.change||i,a=r.propertyclick||i;return this.each(function(){t(e(this),n,u,a,r.propertyElement,r.valueElement)})};var v="object array boolean number string null"})(jQuery);