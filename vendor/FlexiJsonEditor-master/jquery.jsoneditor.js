// Copyright (c) 2013 David Durman

// Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php).

(function(e){function t(t,n,r,i,s,o){var u={target:t,onchange:r,onpropertyclick:i,original:n,propertyElement:s,valueElement:o};m(u,n,u.target),e(u.target).on("blur focus",".property, .value",function(){e(this).toggleClass("editing")})}function n(e){return Object.prototype.toString.call(e)=="[object Object]"}function r(e){return Object.prototype.toString.call(e)=="[object Array]"}function i(e){return Object.prototype.toString.call(e)=="[object Boolean]"}function s(e){return Object.prototype.toString.call(e)=="[object Number]"}function o(e){return Object.prototype.toString.call(e)=="[object String]"}function a(e,t,n){var r=arguments.length==2;if(t.indexOf(".")>-1){var i=e,s=0,o=t.split(".");for(var u=o.length;s<u-1;s++)i=i[o[s]];r?delete i[o[u-1]]:i[o[u-1]]=n}else r?delete e[t]:e[t]=n;return e}function f(e,t,n){t=t.split(".");var r=0;while(r<t.length)if((e=e[t[r++]])==undefined)return n;return e}function l(e){window.console&&console.error(e)}function c(e){var t;try{t=JSON.parse(e)}catch(n){t=null,l("JSON parse failed.")}return t}function h(e){var t;try{t=JSON.stringify(e)}catch(n){t="null",l("JSON stringify failed.")}return t}function p(t){if(t.children(".expander").length==0){var n=e("<span>",{"class":"expander"});n.bind("click",function(){var t=e(this).parent();t.toggleClass("expanded")}),t.prepend(n)}}function d(t,n){var r=e("<div>",{"class":"item appender"}),i=e("<button></button>",{"class":"property"});return i.text("Add New Value"),r.append(i),t.append(r),i.click(n),r}function v(e){if(r(e))return e.push(null),!0;if(n(e)){var t=1,i="newKey";while(e.hasOwnProperty(i))i="newKey"+t,t++;return e[i]=null,!0}return!1}function m(t,i,s,o){o=o||"",s.children(".item").remove();for(var u in i){if(!i.hasOwnProperty(u))continue;var a=e("<div>",{"class":"item","data-path":o}),f=e(t.propertyElement||"<input>",{"class":"property"}),l=e(t.valueElement||"<input>",{"class":"value"});(n(i[u])||r(i[u]))&&p(a),a.append(f).append(l),s.append(a),f.val(u).attr("title",u);var g=h(i[u]);l.val(g).attr("title",g),E(a,i[u]),f.change(b(t)),l.change(w(t)),f.click(y(t)),(n(i[u])||r(i[u]))&&m(t,i[u],a,(o?o+".":"")+u)}(n(i)||r(i))&&d(s,function(){v(i),m(t,i,s,o),t.onchange(c(h(t.original)))})}function g(t,n){e(t).parentsUntil(n.target).each(function(){var t=e(this).data("path");t=(t?t+".":t)+e(this).children(".property").val();var r=h(f(n.original,t,null));e(this).children(".value").val(r).attr("title",r)})}function y(t){return function(){var n=e(this).parent().data("path"),r=e(this).attr("title"),i=n?n.split(".").concat([r]).join("']['"):r;t.onpropertyclick("['"+i+"']")}}function b(t){return function(){var n=e(this).parent().data("path"),r=c(e(this).next().val()),i=e(this).val(),s=e(this).attr("title");e(this).attr("title",i),a(t.original,(n?n+".":"")+s),i&&a(t.original,(n?n+".":"")+i,r),g(this,t),i||e(this).parent().remove(),t.onchange(c(h(t.original)))}}function w(t){return function(){var i=e(this).prev().val(),s=c(e(this).val()||"null"),o=e(this).parent(),u=o.data("path");a(t.original,(u?u+".":"")+i,s),(n(s)||r(s))&&!e.isEmptyObject(s)?(m(t,s,o,(u?u+".":"")+i),p(o)):o.find(".expander, .item").remove(),E(o,s),g(this,t),t.onchange(c(h(t.original)))}}function E(e,t){var a="null";n(t)?a="object":r(t)?a="array":i(t)?a="boolean":o(t)?a="string":s(t)&&(a="number"),e.removeClass(u),e.addClass(a)}e.fn.jsonEditor=function(n,r){r=r||{},n=c(h(n));var i=function(){},s=r.change||i,o=r.propertyclick||i;return this.each(function(){t(e(this),n,s,o,r.propertyElement,r.valueElement)})};var u="object array boolean number string null"})(jQuery);